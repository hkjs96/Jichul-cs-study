# Load Balancing( 부하 분산 , 로드 밸런싱)
- **둘 혹은 셋 이상의 중앙처리장치 혹은 저장장치와 같은 컴퓨터 자원들에 작업을 나누는 것을 의미**
- 가용성 및 응답시간을 최적화
- 대부분의 응용 프로그램은 다수의 서버를 가지고 한 가지 종류의 인터넷 서비스를 지원하는 방식이다.
- 트래픽이 많은 웹 사이트, 인터넷 릴레이 챗(IRC, Internet Relay Chat) 네트워크, 파일 전송 프로토콜(FTP, File Transfer Protocol) 사이트, 네트워크 뉴스 전송 프로토콜(NNTP, Network News Transfer Protocol) 서버 그리고 DNS 서버에 적용
- 인터넷 서비스를 위해서는 소프트웨어를 이용한 로드밸런싱이 적용되며, 이 소프트웨어는 중간에 위치에 실제 서비스하는 서버와 클라이언트를 포트를 이용해 중개한다.
  - 내부 네트워크 구조를 숨김으로써 투명성 보장 및 크래킹 방지

<img src="https://user-images.githubusercontent.com/75015048/150667234-3cede904-8819-4156-9e7b-f4abc8f56b44.png" width="80%"/>

### 장점
- 비용절감 (저렴한 비용의 다수의 서버를 증설)
- 확장성과 가용성
- 서비스 중단 X 
  - 1대의 서버 장애가 발생해도 서비스를 다른 서버로 적절히 분배)
  - 사용량 증가시 서버 증설 가능
- 단일 제어 지점 제공

### 단점
- 세션 데이터 관리가 어렵다 ( 유지가 안됨 )
  - 이를 위해 세션 고정
    - 고정된 세션의 노드에 장애가 발생하면 고정한 의미가 없어진다. 장애가 발생하여 비활성화된 노드에 대한 고려가 필요하다.

## 로드 밸런서
서버에 가해지는 부하(로드)를 분산(밸런싱) 해서주는 장치 기술을 통칭

## 작동 방식
### L2 로드밸런싱
데이터 링크 계층(L2)에서 정의된 정보를 바탕으로 로드밸런싱 수행
- 맥주소(MAC, Media Access Control Address)를 이용하여 전달할 서버를 결정
- L4, l7 로드밸런서 대비 로드밸런싱 전략이 제한
- L2DSR 전략에서 로드밸런서는 inbound 패킷의 맥주소를 서버의 맥주소로 변환한 뒤 서버에게 전달
  - 이 전략을 사용하기 위해서는 로드밸런서와 서버가 반드시 같은 네트워크에 속해야 한다.
  - 로드밸런서가 알 수 있는 게 맥 주소밖에 없는데, 패킷의 MAC 주소를 서버의 MAC 주소로 변경을 했을 때 이 패킷이 바로 서버로 가야 한다. IP는 그대로인데 MAC 주소만 바꿔서 서버에 도달해야 하는데, 이를 위해서 서버와 로드밸런서 모두 VIP가 설정되어야 하는 등 이런저런 제약이 있다.

### L3 로드밸런싱
- 네트워크 계층(L3)에서 정의된 정보를 바탕으로 로드밸런싱 수행
- 포트 간 패킷 스위칭을 위해 IP 나 IPX 주소를 기반으로 스위칭
- 특정 프로토콜을 사용하는 패킷에 대해 스위칭이 가능
- L2에 라우팅 기능이 추가
  - 라우터가 있다.
- Broadcast 트래픽으로 전체 성능 저하방지
- 트래픽 체크, 가상 랜 등의 많은 부가 기능을 제공
- 특정 프로토콜을 이용해서 스위칭

### L4 로드밸런싱
- 전송 계층(L4)의 정보를 바탕으로 부하를 분산
- IP 주소와 포트 번호를 이용
- L3의 정보도 활용하니까 정확히는 L3 and L4 로드 밸런싱이 맞겠지만, n번 레이어를 활용한다는 것은 n-1 이하의 레이어들도 활용할 수 있다는 것이며 통상 L4 로드밸런싱이라 불림
- L4 로드밸런서는 패킷 헤더의 소스 IP 와 destination IP를 네트워크 주소 변환을 통해 바꿔서 서버에게 전달
- 반대로 클라이언트로 패킷이 갈 때도 소스 IP 와 destination IP를 바꿔서 클라이언트에게 잘 전달
- L2보다는 비용이 더 비싸지만 IP 와 포트 번호를 활용하여 상대적으로 더 섬세한 라우팅이 가능
- 내용물을 보지 않기 때문에 TLS termination이 없다.
<img src="https://user-images.githubusercontent.com/75015048/150667257-2d94f79d-392e-43c8-a907-ce8d61ce27e4.png" width="80%">

### L7 로드밸런싱
- 응용계층(L7)의 정보를 바탕으로 부하를 분산
- TLS termination 발생
- 소프트웨어적인 로드밸런싱이 필요
- L2, L4 로드 밸런싱은 물리적 단계에서 충분하지만, L7은 소프트웨어를 사용해야 하므로 비용이 더 비쌈
- 가장 섬세한 라우팅이 가능
- HTTP 헤더, 쿠키 등과 같은 사용자의 요청을 기준으로 특정 서버에 트래픽을 분산하는 것이 가능
  - 쉽게 말해 패킷의 내용을 확인하고 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능
  - URL에 따라 부하를 분산시키거나, HTTP 헤더의 쿠키값에 따라 부하를 분산하는 등 클라이언트의 요청을 보다 세분화해 서버에 전달
-  특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며, DoS/DDoS와 같은 비정상적인 트래픽을 필터링할 수 있어 네트워크 보안 분야에서도 활용된다.
<img src="https://user-images.githubusercontent.com/75015048/150667276-17d0aa62-21f7-4dbc-8417-a245a0d76549.png" width="80%" />

### L4와 L7 표로 비교
<img src="https://user-images.githubusercontent.com/75015048/150666559-4f3a28f3-2e27-4ec5-8620-9f4ebafc9765.png"
width="80%" />

## 로드밸런싱 유형
로드밸런싱 유형에는 관계형 데이터베이스를 위한 SQL Server 로드밸런싱, 여러 지리적 위치에서의 문제 해결을 위한 글로벌 서버 로드밸런싱, 도메인 이름 기능을 보장하기 위한 DNS 서버 로드밸런싱 등 네트워크에 대해 고려해야 할 여러 가지 특정 유형의 로드밸런싱이 있다.

### 네트워크 로드밸런싱
- 네트워크 계층 정보를 활용하여 네트워크 트래픽을 전송할 위치를 결정
- 모든 형태의 TCP/UDP 트래픽을 처리하도록 설계된 4계층 로드밸런싱을 통해 달성
- 네트워크 부하 분산은 모든 부하 분산 솔루션 중 가장 빠른 것으로 여겨지지만, 서버 간 트래픽 분산에 있어서는 부족한 경향이 있다.

### HTTP(S) 로드밸런싱
- HTTP(S) 로드밸런싱은 가장 오래된 형태의 로드밸런싱 중 하나
- L7에 의존하며, 이는 애플리케이션 계층에서 작동한다는 것을 의미
- HTTP 주소와 함께 제공되는 정보를 기반으로 배포 결정을 형성할 수 있기 때문에 종종 가장 유연한 유형의 로드밸런싱이라고 불린다.

### 내부 로드밸런싱
- 네트워크 부하 분산과 거의 동일하지만 내부 인프라의 균형을 맞추기 위해 활용
- 로드밸런싱 장치의 유형을 말할 때 하드웨어 로드밸런싱 장치, 소프트웨어 로드밸런싱 장치 및 가상 로드밸런싱 장치가 있다는 점도 유의해야 한다.

## 로드밸런싱 알고리즘
### 라운드로빈 방식(Round Robin Method)
- 서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식
- 클라이언트의 **요청을 순서대로 분배**하기 때문에 여러 대의 서버가 동일한 스펙을 갖고 있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합

### 가중 라운드로빈 방식(Weighted Round Robin Method)
- 각각의 서버마다 **가중치**를 매기고 가중치가 높은 서버에 클라이언트 요청을 우선적으로 배분
- 주로 서버의 트래픽 처리 능력이 상이한 경우 사용되는 부하 분산 방식

예를 들어 A라는 서버가 5라는 가중치를 갖고 B라는 서버가 2라는 가중치를 갖는다면, 로드밸런서는 라운드로빈 방식으로 A 서버에 5개 B 서버에 2개의 요청을 전달합니다.

### IP 해시 방식(IP Hash Method)
- 클라이언트의 **IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식**
- 사용자의 IP를 해싱해(Hashing, 임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑하는 것, 또는 그러한 함수) 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장 

### 최소 연결 방식(Least Connection Method)
- 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분
- 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합한 방식

### 최소 리스폰타임(Least Response Time Method)
- 서버의 현재 연결 상태와 응답시간(Response Time, 서버에 요청을 보내고 최초 응답을 받을 때까지 소요되는 시간)을 모두 고려하여 트래픽을 배분
- 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분하는 방식

## 주요 기술
- NAT(Network Address Translation)
  - private IP를 public IP로 바꾸는데 사용하는 통신망의 주소변조기
- DSR(Dynamic Source Routing protocol)
  - 로드밸런서 사용 시 서버에서 클라이언트로 되돌아가는 경우 목적지 주소를 스위치의 IP주소가 아닌 클라이언트의 IP 주소로 전달해서 네트워크 스위치를 거치지 않고 바로 클라이언트를 찾아가는 개념
- Tunneling
  - 인터넷 상에서 눈에 보이지 않는 통로를 만들어 통신할 수 있게 하는 개념
  - 데이터를 캡슐화해서 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제할 수 있다.

# 참고 
[로드밸런싱 - 해시넷](http://wiki.hash.kr/index.php/%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1)

[기비아 - 로드밸런서의 개요와 특징](https://m.post.naver.com/viewer/postView.naver?volumeNo=27046347&memberNo=2521903)

[이해하기 네트워크의 부하분산, 로드밸런싱](https://www.stevenjlee.net/2020/06/30/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%EC%9D%98-%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-load-balancing-%EA%B7%B8/)

[로드 밸런싱과 클러스터링](https://goodgid.github.io/Load-Balancing-And-Clustering/)

[L2 / L4 / L7 로드 밸런싱](https://2kindsofcs.tistory.com/56)

[로드 밸런서](https://nesoy.github.io/articles/2018-06/Load-Balancer)
